Ansible Contriller
ssh ubuntu@18.118.185.155

=======================
Create Role - mytomcat-role
=======================
 Use ansible-galaxy command to create a Ansible roles which has the templates to create it. 

A) On Ansible Controller
===================
1) Create mytomcat-playbook.yml under MyWork

touch mytomcat-playbook.yml

2) Open Roles folder

cd roles

3) Create the Role using ansible-galaxy command

roles> ansible-galaxy  init mytomcat-role
- Role mytomcat-role was created successfully

4) You can see mytomcat-role is created and observe following directory sructure.

roles $  ls -l

roles $  tree mytomcat-role

mywork/roles $ tree mytomcat-role

hello-role
├── README.md
├── defaults
│   └── main.yml
├── files
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── tasks
│   └── main.yml
├── templates
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml


5) Remove the folders which are not required

mywork/roles/mytomcat-role $ rm -rf defaults tests meta

6) See the Directory structure after Removing unnecessary

roles $  tree mytomcat-role

mywork/roles $ tree mytomcat-role

mytomcat-role
├── README.md
├── files
├── handlers
│   └── main.yml
├── tasks
│   └── main.yml
├── templates
└── vars
    └── main.yml

B) On Local Machine
===================
7) Create the Directory structure for mytomcat-role in local machine.

8) Create mytomcat-role folder in roles folder

9)  Create vars folder  mytomcat-role folder

10) Write main.yml in vars  folder as follows.
========
main.yml
========
#  variables for mytomcat-role

admin_username: admin
admin_password: admin

user1_name: srinivas
user1_password: srinivas

user2_name: tomcat
user2_password: tomcat


11)  Create files folder  mytomcat-role folder

12) Place the required files here
*** We are considering following files 
a) myjlcapp.war
b) apache-tomcat-8.5.53.tar.gz

13)  Create templates folder  mytomcat-role folder

14) Place the required template files here
*** We are considering tomcat-users.xml as follows

<?xml version='1.0' encoding='utf-8'?>

<tomcat-users>

<role rolename="manager-gui"/>

  <user username="{{ admin_username }}" password="{{ admin_password }}" roles="manager-gui" />
  <user username="{{ user1_name }}" password="{{ user1_password }}" roles="manager-status" />
  <user username="{{ user2_name }}" password="{{ user2_password }}" roles="manager-gui, manager-status" />

</tomcat-users>

15)  Create handlers folder   mytomcat-role folder

16) Write main.yml in handlers folder as follows.
========
main.yml
========
- name: Restart Tomcat
  systemd:
    name: tomcat
    state: restarted
    enabled: yes

17)  Create tasks folder  mytomcat-role folder

18) Write install-java.yml in tasks folder as follows.

========
install-java.yml
========

- name: Install Java 1.8 Ubuntu
  apt:
    name: openjdk-8-jdk
    state: present
  when: ansible_os_family == 'Debian'
- name: Install Java 1.8 RedHat
  yum: 
    name: java-1.8.0-openjdk
    state: present
  when: ansible_os_family == 'RedHat'

19) Write configure-user.yml in tasks folder as follows.

========
configure-user.yml
========
- name: add group "tomcat"
  group:
    name: tomcat
    
- name: add user "tomcat"
  user:
    name: tomcat
    group: tomcat


20) Write install-tomcat.yml in tasks folder as follows.

========
install-tomcat.yml
========
- name: copy Tomcat tar file
  copy:
    src: files/apache-tomcat-8.5.53.tar.gz
    dest: /tmp

- name: Extract archive
  shell: /bin/tar xvf /tmp/apache-tomcat-8.5.53.tar.gz -C /opt

- name: create Symlink
  file:
    src: /opt/apache-tomcat-8.5.53
    path: /opt/tomcat
    owner: tomcat
    group: tomcat
    state: link

- name: Change ownership of Tomcat installation
  file:
    path: /opt/tomcat/
    owner: tomcat
    group: tomcat
    mode: 0755
    state: directory
    recurse: yes

- name: create tomcat.service file
  file:
    path: /etc/systemd/system/tomcat.service
    state: touch

- name: create tomcat service
  blockinfile:
    path: /etc/systemd/system/tomcat.service
    block: |
      [Unit]
      Description=Tomcat - instance %i
      After=syslog.target network.target
      [Service]
      Type=forking
      User=tomcat
      Group=tomcat
      Environment="CATALINA_HOME=/opt/tomcat/"
      ExecStart=/opt/tomcat/bin/startup.sh
      ExecStop=/opt/tomcat/bin/shutdown.sh
      [Install]
      WantedBy=multi-user.target
      
- name: enable & start tomcat service
  systemd:
    name: tomcat
    state: started
    enabled: yes
    

21) Write main.yml in tasks folder as follows.
========
main.yml
========
---  
- name: install java
  include_tasks: install-java.yml

- name: config users
  include_tasks: configure-user.yml

- name: install tomcat
  include_tasks: install-tomcat.yml

- name: Copy tomcat-users.xml
  template: 
    src: templates/tomcat-users.xml
    dest: /opt/tomcat/conf/
  notify: 
    - Restart Tomcat

- name: Deploy myjlcapp.war to Tomcat
  copy: 
    src: files/myjlcapp.war
    dest: /opt/tomcat/webapps
  notify: 
    - Restart Tomcat


19) Update mytomcat-playbook.yml to include nginx-role developed above
=================
mytomcat-playbook.yml
================
---
- name: Using My Tomcat Role in playbook
  hosts: all
  become: true
  
  roles:
    - role: mytomcat-role

20) Now Every thing on Local. Move to Ansible controller 
=========================================================
scp  mytomcat-playbook.yml ubuntu@18.118.185.155:/home/ubuntu/MyWork
scp -r mytomcat-role ubuntu@18.118.185.155:/home/ubuntu/MyWork/roles
=========================================================

C) On Ansible Controller
===================
21)Check the Directory Structure and files on Ansible Controller as follows.

mytomcat-role/
├── README.md
├── defaults
│   └── main.yml
├── files
│   ├── apache-tomcat-8.5.53.tar.gz
│   └── myjlcapp.war
├── handlers
│   └── main.yml
├── tasks
│   ├── configure-user.yml
│   ├── install-java.yml
│   ├── install-tomcat.yml
│   └── main.yml
├── templates
│   └── tomcat-users.xml
└── vars
    └── main.yml

22) Run the Playbook

ansible-playbook mytomcat-playbook.yml

23) Test the Ngins Server running or not.

http://3.145.209.236:8080/
http://3.145.209.236:8080/myjlcapp

http://3.15.8.194:8080/
http://3.15.8.194:8080/myjlcapp

ansible all -a "cat  /opt/tomcat/conf/tomcat-users.xml"

ansible all -a "ls -l /opt/tomcat/webapps"


=====================================
Working with Ansible Galaxy
===================
https://galaxy.ansible.com/

ansible-galaxy init mysql

ansible-galaxy install  mysql

ansible-galaxy install geerlingguy.mysql

scp  mysql-playbook.yml ubuntu@18.118.185.155:/home/ubuntu/MyWork

ansible-playbook mysql-playbook.yml 

/home/ubuntu/.ansible/roles

/home/ubuntu/MyWork/roles

ansible.cfg
==========
roles_path : /home/ubuntu/MyWork/roles

